<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <video id="video" autoplay></video>
    <input id="send" type="submit" style="position: absolute; top: 0; left: 0;">
    <script src="/socket.io/socket.io.js"></script>
    <script src="./kurento-utils/js/kurento-utils.min.js"></script>
    <script>
        const socket = io("http://localhost:9090")
        const sendElement = document.getElementById("send")
        const videoElement = document.getElementById("video")
        sendElement.onclick = send

        window.addEventListener("load", (event) => {
            participant = new Participant(123, Math.floor(Math.random() * 1000))
        })

        class Participant {
            constructor(roomId, userId) {
                this.roomId = roomId
                this.userId = userId
                this.webRtcPeer
                this.sendCandidates = []
                this.recvCandidates = []
                this.event()
            }

            event = () => {
                socket.on("sendMedia-ok", message => {
                    const endpoint = message.endpoint
                    const sdpAnswer = message.sdpAnswer
                    this.sendCandidates.forEach(candidate => {
                        socket.emit("addIceCandidate", {
                            roomId: this.roomId,
                            endpoint: endpoint,
                            candidate: candidate
                        })
                    })
                    this.sendCandidates = []
                    this.webRtcPeer.processAnswer(sdpAnswer, (error) => {
                        sendElement.onclick = send
                        if (error) return console.error(error)
                        this.webRtcPeer.showLocalVideo()
                    })
                })

                socket.on("getMedia-ok", message => {
                    const endpoint = message.endpoint
                    const sdpAnswer = message.sdpAnswer
                    this.recvCandidates.forEach(candidate => {
                        socket.emit("addIceCandidate", {
                            roomId: this.roomId,
                            endpoint: endpoint,
                            candidate: candidate
                        })
                    })
                    this.recvCandidates = []
                    this.webRtcPeer.processAnswer(sdpAnswer, (error) => {
                        if (error) return console.error(error)
                    })
                })

                socket.on("addIceCandidate", message => {
                    this.webRtcPeer.addIceCandidate(message.candidate)
                })

                socket.on("newMedia", message => {
                    const sdpAnswer = message.sdpAnswer
                    const endpoint = message.endpoint
                    this.getMedia(endpoint)
                })
            }

            sendMedia = () => {
                const roomId = this.roomId
                const userId = this.userId
                const constraints = {
                    video: {
                        width: 640,
                        framerate: 15
                    }
                }
                const options = {
                    localVideo: videoElement,
                    onicecandidate: (candidate) => {
                        this.sendCandidates.push(candidate)
                    },
                    mediaConstraints: constraints
                }
                this.webRtcPeer = new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(options, function (error) {
                    if (error) return console.error(error)
                    this.generateOffer((error, sdp) => {
                        if (error) return console.error(error)
                        socket.emit("sendMedia", {
                            roomId: roomId,
                            userId: userId,
                            sdp: sdp
                        })
                    })
                })
            }

            getMedia = (endpointSender) => {
                const roomId = this.roomId
                const userId = this.userId
                const constraints = {
                    video: {
                        width: 640,
                        framerate: 15
                    }
                }
                const options = {
                    remoteVideo: videoElement,
                    onicecandidate: (candidate) => {
                        this.sendCandidates.push(candidate)
                    },
                    mediaConstraints: constraints
                }
                this.webRtcPeer = new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options, function (error) {
                    if (error) return console.error(error)
                    this.generateOffer((error, sdp) => {
                        if (error) return console.error(error)
                        socket.emit("getMedia", {
                            roomId: roomId,
                            endpointSender: endpointSender,
                            sdp: sdp
                        })
                    })
                })
            }
        }

        function send(event) {
            const element = event.target
            element.onclick = null
            const roomId = 123
            const userId = 1
            participant.sendMedia()
        }
    </script>
</body>

</html>