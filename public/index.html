<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <video id="localVideo" playsinline autoplay style="width: 350px; height: 200px;"></video>
    <video id="remoteVideo" playsinline autoplay style="width: 350px; height: 200px;"></video>
    <input id="send" type="submit" value="send" style="position: absolute; top: 0; left: 0;">
    <script src="/socket.io/socket.io.js"></script>
    <script src="./kurento-utils/js/kurento-utils.min.js"></script>
    <script>
        const socket = io("http://localhost:9090")
        const sendElement = document.getElementById("send")
        const localVideo = document.getElementById("localVideo")
        const remoteVideo = document.getElementById("remoteVideo")
        var participant
        sendElement.onclick = send

        window.addEventListener("load", (event) => {
            participant = new Participant(123, Math.floor(Math.random() * 1000))
        })

        class Participant {
            constructor(roomId, userId) {
                this.roomId = roomId
                this.userId = userId
                this.webRtcPeerSend
                this.webRtcPeerGet
                this.sendCandidates = []
                this.recvCandidates = []
                this.event()
            }

            event = () => {
                socket.on("sendMedia-ok", message => {
                    const endpoint = message.endpoint
                    const sdpAnswer = message.sdpAnswer
                    this.sendCandidates.forEach(candidate => {
                        socket.emit("addIceCandidate", {
                            roomId: this.roomId,
                            endpoint: endpoint,
                            candidate: candidate
                        })
                    })
                    this.sendCandidates = []
                    this.webRtcPeerSend.processAnswer(sdpAnswer, (error) => {
                        if (error) {
                            sendElement.onclick = send
                            return console.error(error)
                        }
                        this.webRtcPeerSend.showLocalVideo()
                        sendElement.value = "close"
                        sendElement.onclick = (event) => dispose(event, endpoint)
                    })
                })

                socket.on("getMedia-ok", message => {
                    const endpoint = message.endpoint
                    const sdpAnswer = message.sdpAnswer
                    this.recvCandidates.forEach(candidate => {
                        socket.emit("addIceCandidate", {
                            roomId: this.roomId,
                            endpoint: endpoint,
                            candidate: candidate
                        })
                    })
                    this.recvCandidates = []
                    this.webRtcPeerGet.processAnswer(sdpAnswer, (error) => {
                        if (error) return console.error(error)
                    })
                })

                socket.on("closeMedia-ok", () => {
                    sendElement.value = "send"
                    sendElement.onclick = send
                })

                socket.on("addIceCandidate", message => {
                    this.webRtcPeerSend && this.webRtcPeerSend.addIceCandidate(message.candidate)
                    this.webRtcPeerGet && this.webRtcPeerGet.addIceCandidate(message.candidate)
                })

                socket.on("newMedia", message => {
                    const sdpAnswer = message.sdpAnswer
                    const endpoint = message.endpoint
                    this.getMedia(endpoint)
                })

                socket.on("disposeMedia", () => {
                    this.webRtcPeerGet.dispose()
                })
            }

            sendMedia = () => {
                const roomId = this.roomId
                const userId = this.userId
                const constraints = {
                    video: {
                        width: 350,
                        height: 200,
                        framerate: 15
                    }
                }
                const options = {
                    localVideo: localVideo,
                    onicecandidate: (candidate) => {
                        this.sendCandidates.push(candidate)
                    },
                    mediaConstraints: constraints
                }
                this.webRtcPeerSend = new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(options, function (error) {
                    if (error) return console.error(error)
                    this.generateOffer((error, sdp) => {
                        if (error) return console.error(error)
                        socket.emit("sendMedia", {
                            roomId: roomId,
                            userId: userId,
                            sdp: sdp
                        })
                    })
                })
            }

            getMedia = (endpointSender) => {
                const roomId = this.roomId
                const userId = this.userId
                const constraints = {
                    video: {
                        width: 350,
                        height: 200,
                        framerate: 15
                    }
                }
                const options = {
                    remoteVideo: remoteVideo,
                    onicecandidate: (candidate) => {
                        this.sendCandidates.push(candidate)
                    },
                    mediaConstraints: constraints
                }
                this.webRtcPeerGet = new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options, function (error) {
                    if (error) return console.error(error)
                    this.generateOffer((error, sdp) => {
                        if (error) return console.error(error)
                        socket.emit("getMedia", {
                            roomId: roomId,
                            endpointSender: endpointSender,
                            sdp: sdp
                        })
                    })
                })
            }
        }

        function send(event) {
            const element = event.target
            element.onclick = null
            participant.sendMedia()
        }

        function dispose(event, endpoint) {
            const element = event.target
            element.onclick = null
            participant.webRtcPeerSend.dispose()
            socket.emit("closeMedia", {
                roomId: participant.roomId,
                endpoint: endpoint
            })
        }
    </script>
</body>

</html>