<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <input id="send" type="submit" value="send" style="position: absolute; top: 0; left: 0;">
    <script src="/socket.io/socket.io.js"></script>
    <script src="./kurento-utils/js/kurento-utils.min.js"></script>
    <script>
        const socket = io("http://localhost:9090")
        const sendElement = document.getElementById("send")
        const localVideo = document.getElementById("localVideo")
        const remoteVideo = document.getElementById("remoteVideo")
        var participant
        sendElement.onclick = send

        window.addEventListener("load", (event) => {
            participant = new Participant(123, Math.floor(Math.random() * 1000))
        })

        class Participant {
            constructor(roomId, userId) {
                this.roomId = roomId
                this.userId = userId
                this.webRtcPeer
                this.webRtcPeerRecv = {}
                this.sendCandidates = []
                this.recvCandidates = []
                this.event()
            }

            event = () => {
                socket.on("sendMedia-ok", message => {
                    const endpoint = message.endpoint
                    const sdpAnswer = message.sdpAnswer
                    this.sendCandidates.forEach(candidate => {
                        socket.emit("addIceCandidate", {
                            roomId: this.roomId,
                            endpoint: endpoint,
                            candidate: candidate
                        })
                    })
                    this.sendCandidates = []
                    this.webRtcPeer.processAnswer(sdpAnswer, (error) => {
                        if (error) {
                            sendElement.onclick = send
                            return console.error(error)
                        }
                        this.webRtcPeer.showLocalVideo()
                        sendElement.value = "close"
                        sendElement.onclick = (event) => dispose(event, endpoint)
                    })
                })

                socket.on("getMedia-ok", message => {
                    const endpoint = message.endpoint
                    const endpointSender = message.endpointSender
                    const sdpAnswer = message.sdpAnswer
                    this.recvCandidates.forEach(candidate => {
                        socket.emit("addIceCandidate", {
                            roomId: this.roomId,
                            endpoint: endpoint,
                            candidate: candidate
                        })
                    })
                    this.recvCandidates = []
                    const webRtcPeerRecv = this.webRtcPeerRecv[endpointSender.id]
                    webRtcPeerRecv.processAnswer(sdpAnswer, (error) => {
                        if (error) return console.error(error)
                    })
                })

                socket.on("closeMedia-ok", () => {
                    sendElement.value = "send"
                    sendElement.onclick = send
                })

                socket.on("addIceCandidateSend", message => {
                    this.webRtcPeer.addIceCandidate(message.candidate)
                })

                socket.on("addIceCandidateGet", message => {
                    const endpointSender = message.endpointSender
                    const candidate = message.candidate
                    const webRtcPeerRecv = this.webRtcPeerRecv[endpointSender.id]
                    webRtcPeerRecv.addIceCandidate(candidate)
                })

                socket.on("newMedia", message => {
                    const sdpAnswer = message.sdpAnswer
                    const endpoint = message.endpoint
                    this.getMedia(endpoint)
                })

                socket.on("disposeMedia", message => {
                    const endpoint = message.endpoint
                    const video = document.getElementById(endpoint.id)
                    const webRtcPeerRecv = this.webRtcPeerRecv[endpoint.id]
                    webRtcPeerRecv.dispose()
                    video.remove()
                    delete this.webRtcPeerRecv[endpoint.id]
                })
            }

            sendMedia = () => {
                const roomId = this.roomId
                const userId = this.userId
                const video = document.createElement("video")
                video.setAttribute("playsinline", "")
                video.setAttribute("autoplay", "")
                video.setAttribute("style", "width: 350px; height: 200px; margin-top: 10px;")
                video.id = userId
                document.body.appendChild(video)
                const constraints = {
                    video: {
                        width: 350,
                        height: 200,
                        framerate: 15
                    }
                }
                const options = {
                    localVideo: video,
                    onicecandidate: (candidate) => {
                        this.sendCandidates.push(candidate)
                    },
                    mediaConstraints: constraints
                }
                this.webRtcPeer = new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(options, function (error) {
                    if (error) return console.error(error)
                    this.generateOffer((error, sdp) => {
                        if (error) return console.error(error)
                        socket.emit("sendMedia", {
                            roomId: roomId,
                            userId: userId,
                            sdp: sdp
                        })
                    })
                })
            }

            getMedia = (endpointSender) => {
                const roomId = this.roomId
                const userId = this.userId
                const endpointId = endpointSender.id
                const video = document.createElement("video")
                video.setAttribute("playsinline", "")
                video.setAttribute("autoplay", "")
                video.setAttribute("style", "width: 350px; height: 200px; margin-top: 10px;")
                video.id = endpointId
                document.body.appendChild(video)
                const constraints = {
                    video: {
                        width: 350,
                        height: 200,
                        framerate: 15
                    }
                }
                const options = {
                    remoteVideo: video,
                    onicecandidate: (candidate) => {
                        this.sendCandidates.push(candidate)
                    },
                    mediaConstraints: constraints
                }
                this.webRtcPeerRecv[endpointId] = new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options,
                    function (error) {
                        if (error) return console.error(error)
                        this.generateOffer((error, sdp) => {
                            if (error) return console.error(error)
                            socket.emit("getMedia", {
                                roomId: roomId,
                                endpointSender: endpointSender,
                                sdp: sdp
                            })
                        })
                    })
            }
        }

        function send(event) {
            const element = event.target
            element.onclick = null
            participant.sendMedia()
        }

        function dispose(event, endpoint) {
            const element = event.target
            const video = document.getElementById(participant.userId)
            element.onclick = null
            participant.webRtcPeer.dispose()
            video.remove()
            socket.emit("closeMedia", {
                roomId: participant.roomId,
                endpoint: endpoint
            })
        }
    </script>
</body>

</html>